<div class="uk-flex uk-flex-top uk-flex-center" style="margin: 5% auto;">
    <div class="uk-width-3-5" style="margin: 0 auto">
        <form id="regForm" method="POST" action="">
            <h1 class="mb-5">Создать товар</h1>


            <div class="tab" style="margin-bottom: 5% ">
                <div class="uk-flex uk-flex-top uk-flex-between uk-margin-medium-bottom">
                    <div class="uk-width-2-5">
                        <label>Название товара <i uk-tooltip="ВВедите название товара" uk-icon="question"></i></label>
                        <div>
                            {{ form8.product_name }}
                        </div>
                    </div>
                    <div class="uk-width-2-5">
                        <label>Бренд <i uk-tooltip="ВВедите название товара" uk-icon="question"></i></label>
                        <div>
                            {{ form8.brand }}
                        </div>
                    </div>
                </div>
                <div class="uk-flex uk-flex-top uk-flex-between uk-margin-medium-bottom">
                    <div class="uk-width-2-5 uk-flex-row">
                        <label> Фотография товара <i
                                uk-tooltip="Укажите, через сколько покупатель сможет получить свой товар после покупки"
                                uk-icon="question"></i></label>
                        <div class="uk-width-1 uk-margin-small-bottom" uk-form-custom="target: true">
                            <input type="file">
                            <input class="uk-input" name="product_photos" type="text" placeholder="Выбрать файл"
                                disabled>
                        </div>
                        <div class="uk-width-1 uk-margin-small-bottom">
                            <label> Срок получения товара <i
                                    uk-tooltip="Укажите, через сколько покупатель сможет получить свой товар после покупки"
                                    uk-icon="question"></i></label>
                            {{ form8.duration }}
                        </div>
                        <div class="uk-width-1 uk-margin-small-bottom">
                            <label> Категория <i uk-tooltip="К какой категории вы относите свой товар?"
                                    uk-icon="question"></i></label>
                            {{ form8.category }}
                        </div>
                        <div class="uk-width-1 uk-margin-small-bottom">
                            <label>Трана произваодетель <i
                                    uk-tooltip="Опишите свой товар. Так покупателям будет легче понять, что они точно хотят его купить"
                                    uk-icon="question"></i></label>
                            {{ form8.country }}
                        </div>
                    </div>
                    <div class="uk-width-2-5 uk-margin-small-bottom">
                        <label>Описание <i
                                uk-tooltip="Опишите свой товар. Так покупателям будет легче понять, что они точно хотят его купить"
                                uk-icon="question"></i></label>
                        {{ form8.description }}
                    </div>
                </div>


                <div class="uk-flex uk-flex-top uk-flex-between uk-margin-medium-bottom">
                    <div class="uk-width-2-5">
                        <label>Комлектация товара <i
                                uk-tooltip="Введите все, что идет в комплекте с товаром. Не забудьте нажать на плючик, что бы добавить комплект к товару"
                                uk-icon="question"></i></label>
                        <div class="uk-flex uk-flex-left uk-flex-middle uk-width-1 uk-margin-medium-bottom">
                            <input type="text" id="compNmae" maxlength="40" class="changeble uk-input uk-width-3-6">
                            <div class="uk-inline uk-width-1-4">
                                <input type="number" oninput="PercentageChecker(this)" id="compPercentage" min="0"
                                    max="100" style="border-left: none; border-right: none;" class="uk-input">
                                <span class="uk-form-icon uk-form-icon-flip">%</span>
                            </div>
                            <button class="uk-button uk-button-default uk-width-1-6" style="padding:0" id="btnAdd"
                                name="addComplect" onclick="addInput(this)" type="button"><i
                                    class="fa fa-plus"></i></button>
                        </div>
                        <!-- template start -->
                        <div id="inputDiv" class="uk-width-1 uk-flex-row">
                        </div>
                        <!-- template end -->
                    </div>
                    <div class="uk-width-2-5">
                        <label> Размерный ряд <i
                                uk-tooltip="Введите все, что идет в комплекте с товаром. Не забудьте нажать на плючик, что бы добавить комплект к товару"
                                uk-icon="question"></i></label>
                        <div class="uk-flex uk-flex-left uk-flex-middle uk-width-1 uk-margin-medium-bottom">
                            <input type="text" id="size" maxlength="10" class="changeble uk-input uk-width-3-6">
                            <button class="uk-button uk-button-default uk-width-1-6" style="padding:0" id="btnAdd"
                                name="addComplect" onclick="addSize(this)" type="button"><i
                                    class="fa fa-plus"></i></button>
                        </div>
                        <!-- template start -->
                        <div id="sizeInput" class="uk-width-1">
                        </div>
                        <!-- template end -->
                    </div>
                </div>

            </div>

            <div class="tab" style="display: none;">
                <table class="uk-table uk-table-justify uk-table-divider" id="pricing">
                    <thead>
                        <tr>
                            <th class="uk-width-auto">название</th>
                            <th class="uk-width-auto">Размер</th>
                            <th class="uk-width-auto">Цена</th>
                            <th class="uk-width-auto uk-text-center">Итоговая стоимость</th>
                        </tr>
                    </thead>
                    <tbody id="table">

                    </tbody>
                </table>
            </div>

            {% csrf_token %}

            <span>{{error}}</span>


            <div style="overflow:auto;" id="next-previous">
                <div style="float:right;">
                    <button type="button" id="prevBtn"
                        style="display: none; border-radius: 1000px; text-align:center; width: 50px; height: 50px; padding: 0;"
                        class="uk-button" onclick="nextPrev(-1)">
                        <i class="fa fa-angle-double-left"></i>
                    </button>
                    <button name="product_creator" type="button" id="nextBtn"
                        style="border-radius: 1000px; text-align:center; width: 50px; height: 50px; padding: 0; background-color: gray;"
                        class="uk-button uk-button-primary" onclick="nextPrev(1)">
                        <i class="fa fa-angle-double-right"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    var inputnum = 0,
        sizeInput = 0,
        currentTab = 0;

    function PassChecker(n) {
        let product_name = document.getElementById("product_name").value.length;
        let brand = document.getElementById("brand").value.length;
        let description = document.getElementById("description").value.length;
        let comps = document.getElementById('inputDiv').children.length
        let sizes = document.getElementById('sizeInput').children.length
        let btn = document.getElementById('nextBtn')
        if (n == 1 && product_name > 0 && brand > 0 && description > 0 && comps > 0 && sizes > 0) {
            btn.style["background-color"] = 'blue'
            btn.disabled = false;
            return 1
        } else if (n == 2) {
            let poles = document.getElementsByClassName("price")
            let checker = false
            for (let i = 0; i < poles.length; i++) {
                if (poles[i].value.length > 0) {
                    checker = true
                }
            }
            if (checker) {
                btn.style["background-color"] = 'blue'
                btn.disabled = false;
                localStorage.page = 5;
                btn.type = "submit"
                return 1
            } else {
                btn.style["background-color"] = 'gray'
                btn.disabled = true;
                return 0
            }
        }

    }

    function recalc(el) {
        let price = parseInt(el.value)
        let form = el.parentElement.parentElement.getElementsByClassName('final_price')[0];
        let sum = price + price * 0.1
        if (price >= 10000000) {
            el.value = 10000000
            sum = 10000000
        }
        form.innerHTML = sum + "₽"
        PassChecker(2)
    }

    function addComplectation() {
        let name = document.getElementById('product_name').value;
        let sizes = document.getElementById('sizeInput').children
        table = document.getElementById('table')
        for (let i = 0; i < sizes.length; i++) {
            let size = sizes[i].getElementsByClassName('complectations_size')[0].value
            table.innerHTML +=
                `<tr> <td class="uk-text-truncate">${name}</td> <td class="uk-width-1-4">${size}</td> <td class="uk-width-1-4"><input class="uk-input price" type="number" name="price_${i}" oninput="recalc(this)" required></td> <td class="uk-width-1-4 uk-text-center"><p class="final_price"></p></td> </tr>`;
        }
    }

    function addInput(el) {
        // let input = el.parentElement.getElementsByTagName("input")[0];
        let name = document.getElementById('compNmae');
        let percentage = document.getElementById('compPercentage');
        if (inputnum < 15 && name.value && percentage.value) {
            name.removeAttribute("disabled");
            percentage.removeAttribute("disabled");
            name.placeholder = "Введите состав товара";
            var $inputGroup =
                `<div class="uk-flex uk-flex-center uk-flex-middle"> <input type="text" class="uk-input uk-width-3-6 complectations_name" name="compName_${inputnum}" value="${name.value}" readonly> <div class="uk-inline uk-width-1-4"> <input type="number" oninput="PercentageChecker(this)" class="uk-input complectations_percent" name="compPercentage_${inputnum}" value="${percentage.value}" readonly> <span class="uk-form-icon uk-form-icon-flip">%</span> </div> <button class="uk-button uk-button-default uk-width-1-6" style="padding: 0" onclick="changeInput(this)" type="button"> <i uk-icon="pencil" id="editon"></i> <i uk-icon="check" id="editoff" style="display: none"></i>  </button> <button class="uk-button uk-button-default uk-width-1-6" style="padding: 0" onclick="removeEl(this, 0)" type="button"> <i class="fa fa-minus"></i> </button> </div> `;
            // <button class="btn btn-outline-secondary" onclick="changeInput(this)" type="button"><span class="material-icons"> mode_edit </span></button>
            document.getElementById("inputDiv").insertAdjacentHTML("afterbegin", $inputGroup);
            name.value = "";
            percentage.value = "";
            inputnum++;
        } else if (inputnum >= 15) {
            name.value = "";
            percentage.value = "";
            name.setAttribute("disabled", "disabled");
            name.placeholder = "Вы ввели максимальное количество составляющих товара";
        } else {
            name.placeholder = "Для добавления элемента необходимо заполнить эти поля";
        }
        PassChecker(1)
    }

    function addSize(el) {
        let size = document.getElementById('size');
        if (sizeInput < 15 && size.value) {
            size.removeAttribute("disabled");
            size.placeholder = "Введите состав товара";
            var $inputGroup =
                `<div class="uk-flex uk-flex-center uk-flex-middle uk-width-1-3"> <input type="text" class="uk-input uk-width-3-5 complectations_size" name="size_${sizeInput}" value="${size.value}" readonly> <button class="uk-button uk-button-default uk-width-1-5" style="padding: 0" onclick="removeEl(this, 1)" type="button"> <i class="fa fa-minus"></i> </button> </div> `;
            // <button class="btn btn-outline-secondary" onclick="changeInput(this)" type="button"><span class="material-icons"> mode_edit </span></button>
            document.getElementById("sizeInput").insertAdjacentHTML("afterbegin", $inputGroup);
            size.value = "";
            sizeInput++;
        } else if (sizeInput >= 15) {
            size.value = "";
            size.setAttribute("disabled", "disabled");
            size.placeholder = "Вы ввели максимальное количество составляющих товара";
        } else {
            size.placeholder = "Для добавления элемента необходимо заполнить эти поля";
        }
        PassChecker(1)
    }

    function removeEl(el, arg) {
        let mainInput = el.parentElement.parentElement.parentElement.getElementsByClassName("changeble")[0];
        arg ? sizeInput-- : inputnum--;
        if (inputnum < 15 || sizeInput < 15) {
            mainInput.removeAttribute("disabled");
            mainInput.placeholder = "";
        }
        el.parentElement.remove();
        PassChecker(1)
    }

    function changeInput(el) {
        let inputPoleName = el.parentElement.getElementsByTagName("input")[0];
        let inputPolePercantage = el.parentElement.getElementsByTagName("input")[1];
        let editon = el.parentElement.getElementsByTagName("i")[0];
        let editoff = el.parentElement.getElementsByTagName("i")[1];
        inputPoleName.placeholder = "Введите состав товара";
        if (inputPoleName.value && inputPolePercantage.value) {
            if (inputPoleName.readOnly && inputPolePercantage.readOnly) {
                editon.style.display = "none";
                editoff.style.display = "inline-block";
            } else {
                inputPoleName.value = inputPoleName.value
                inputPolePercantage.value = inputPolePercantage.value
                editon.style.display = "inline-block";
                editoff.style.display = "none";
            }
            inputPoleName.readOnly ? inputPoleName.readOnly = false : inputPoleName.readOnly = true;
            inputPolePercantage.readOnly ? inputPolePercantage.readOnly = false : inputPolePercantage.readOnly = true;
        } else {
            inputPoleName.placeholder = "Заполните это поле или удалите его";
        }
        PassChecker(1)
    }

    function PercentageChecker(el) {
        if (el.value > 100) {
            el.value = 100;
        } else if (el.value < 0) {
            el.value = 0;
        }
    }

    document.addEventListener("DOMContentLoaded", function (event) {
        showTab(currentTab);
    });

    function showTab(n) {
        let x = document.getElementsByClassName("tab");
        let len = document.getElementById('table').children.length
        try {
            x[n].style.display = "block";
            if (n === 0) {
                PassChecker(1)
                for (let i = 0; i < len; i++) {
                    document.getElementById('table').children[0].remove()
                }
                document.getElementById("prevBtn").style.display = "none";
            } else if (n === 1) {
                document.getElementById("nextBtn").style["background-color"] = 'gray'
                addComplectation()
                document.getElementById("prevBtn").style.display = "inline";
                PassChecker(2)
            } else if (n == x.length - 1) {
                document.getElementById("prevBtn").style.display = "none";
                document.getElementById("nextBtn").style.display = "none";

            } else {
                for (let i = 0; i < len; i++) {
                    document.getElementById('table').children[0].remove()
                }
                document.getElementById("prevBtn").style.display = "inline";
            }
            fixStepIndicator(n)
        } catch {}
    }

    function nextPrev(n) {
        let x = document.getElementsByClassName("tab");
        let btn = document.getElementById("nextBtn");
        if (n > 0 && currentTab < 2) {
            if (PassChecker(currentTab + 1)) {
                x[currentTab].style.display = "none";
                currentTab = currentTab + n;
                document.getElementById("nextBtn").style["background-color"] = 'gray'
                showTab(currentTab);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Недостаточно данных',
                    text: `Проверьте введенные данные еще раз.`,
                    footer: 'Кога все будет введено правильно, стрелочка подскажет дорогу'
                })
            }
        } else {
            x[currentTab].style.display = "none";
            currentTab = currentTab + n;
            if (currentTab === x.length - 1) {
                document.getElementById('nextBtn').type = "submit"
                document.getElementById('next-previous').classList.add("redirect");
            }
            showTab(currentTab);
        }
    }

    function fixStepIndicator(n) {
        let i, x = document.getElementsByClassName("step");
        for (i = 0; i <
            x.length; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }
    }
</script>